<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroven Sit Locker</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
        }
        
        .page { 
            display: none; 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            margin-bottom: 20px; 
        }
        
        .active { 
            display: block; 
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        
        .logo h1 { 
            color: #4285f4; 
            font-size: 32px; 
            margin-bottom: 10px; 
        }
        
        .logo p { 
            color: #5f6368; 
            font-size: 16px; 
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #333; 
        }
        
        input, button { 
            width: 100%; 
            padding: 14px; 
            border-radius: 8px; 
            border: 2px solid #e1e5e9; 
            font-size: 16px; 
            transition: all 0.3s; 
        }
        
        input:focus { 
            outline: none; 
            border-color: #4285f4; 
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1); 
        }
        
        button { 
            background: linear-gradient(135deg, #4285f4, #34a853); 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            margin-top: 10px; 
            transition: all 0.3s; 
        }
        
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        
        .secondary-btn { 
            background: #f1f3f4; 
            color: #3c4043; 
        }
        
        .secondary-btn:hover { 
            background: #e8eaed; 
            transform: translateY(-2px); 
        }
        
        .key-display { 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
            text-align: center; 
            font-family: 'Courier New', monospace; 
            font-size: 18px; 
            font-weight: bold; 
            position: relative;
            word-break: break-all;
        }
        
        .copy-btn { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: white; 
            width: auto; 
            padding: 8px 12px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 14px;
        }
        
        .copy-btn:hover { 
            background: rgba(255,255,255,0.2); 
            transform: none; 
            box-shadow: none; 
        }
        
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: #34a853; 
            color: white; 
            padding: 15px 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            display: none; 
            z-index: 1000; 
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.error {
            background: #ea4335;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .error { 
            color: #ea4335; 
            font-size: 14px; 
            margin-top: 5px; 
            display: none; 
        }
        
        .key-item { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            border-left: 4px solid #4285f4; 
            transition: all 0.3s; 
        }
        
        .key-item:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); 
        }
        
        .key-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
        }
        
        .key-name { 
            font-weight: 600; 
            font-size: 18px; 
            color: #333; 
        }
        
        .key-email { 
            color: #5f6368; 
            font-size: 14px; 
            margin-bottom: 10px; 
        }
        
        .key-value { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: 'Courier New', monospace; 
            margin: 10px 0; 
            word-break: break-all;
        }
        
        .key-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
        }
        
        .action-btn { 
            padding: 8px 15px; 
            border-radius: 5px; 
            border: none; 
            cursor: pointer; 
            font-size: 14px; 
            transition: all 0.3s; 
            width: auto; 
        }
        
        .copy-action { 
            background: #4285f4; 
            color: white; 
        }
        
        .remove-action { 
            background: #ea4335; 
            color: white; 
        }
        
        .no-keys { 
            text-align: center; 
            color: #5f6368; 
            padding: 40px 20px; 
        }
        
        .back-btn { 
            background: none; 
            border: none; 
            color: #4285f4; 
            width: auto; 
            padding: 10px 0; 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            cursor: pointer;
        }
        
        .back-btn:hover { 
            background: none; 
            transform: none; 
            box-shadow: none; 
            text-decoration: underline; 
        }
        
        .home-header { 
            text-align: center; 
            margin-bottom: 30px; 
        }
        
        .home-header h1 { 
            color: #4285f4; 
            font-size: 36px; 
            margin-bottom: 10px; 
        }
        
        .home-header p { 
            color: #5f6368; 
            font-size: 18px; 
        }
        
        .loading { 
            color: #4285f4; 
        }
        
        .success { 
            color: #34a853; 
        }
        
        .pin-group { 
            position: relative; 
        }
        
        .pin-toggle { 
            position: absolute; 
            right: 10px; 
            top: 40px; 
            background: none; 
            border: none; 
            color: #5f6368; 
            cursor: pointer; 
            width: auto; 
            padding: 0; 
        }
        
        .offline-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #ea4335;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification">Key copied to clipboard!</div>
    <div class="offline-indicator" id="offline-indicator">You are offline</div>

    <div class="container">
        <!-- Welcome Page -->
        <div class="page active" id="welcome-page">
            <div class="logo">
                <h1>Stroven Sit Locker</h1>
                <p>Secure Key Management System</p>
            </div>
            <div class="form-group">
                <button id="create-key-btn">Create New Key</button>
            </div>
            <div class="form-group">
                <button class="secondary-btn" id="login-key-btn">Login with Key</button>
            </div>
        </div>

        <!-- Create Key Page -->
        <div class="page" id="create-key-page">
            <div class="back-btn" id="back-to-welcome">
                <i class="fas fa-arrow-left"></i> Back
            </div>
            <h2>Create Your Key</h2>
            <div class="form-group">
                <label for="user-name">Full Name</label>
                <input type="text" id="user-name" placeholder="Enter your full name">
                <div class="error" id="name-error">Name is required</div>
            </div>
            <div class="form-group">
                <label for="user-email">Email Address</label>
                <input type="email" id="user-email" placeholder="Enter your email">
                <div class="error" id="email-error">Valid email is required</div>
            </div>
            <div class="form-group pin-group">
                <label for="user-pin">PIN (4-6 digits)</label>
                <input type="password" id="user-pin" placeholder="Enter 4-6 digit PIN" maxlength="6">
                <button class="pin-toggle" type="button" id="toggle-pin">
                    <i class="fas fa-eye"></i>
                </button>
                <div class="error" id="pin-error">PIN must be 4-6 digits</div>
            </div>
            <button id="generate-key-btn">Generate Key</button>
        </div>

        <!-- Key Display Page -->
        <div class="page" id="key-display-page">
            <div class="back-btn" id="back-to-create">
                <i class="fas fa-arrow-left"></i> Back
            </div>
            <h2>Your Key is Ready!</h2>
            <p>Save this key securely. You can use it to login to supported platforms.</p>
            
            <div class="key-display">
                <span id="generated-key">STR-XXXX-XXXX-XXXX</span>
                <button class="copy-btn" id="copy-key-btn">
                    <i class="far fa-copy"></i> Copy
                </button>
            </div>
            
            <div class="key-info">
                <p><strong>Name:</strong> <span id="key-user-name"></span></p>
                <p><strong>Email:</strong> <span id="key-user-email"></span></p>
                <p><strong>Created:</strong> <span id="key-created-at"></span></p>
            </div>
            
            <button id="go-to-home">Go to Home</button>
        </div>

        <!-- Login Page -->
        <div class="page" id="login-page">
            <div class="back-btn" id="back-to-welcome2">
                <i class="fas fa-arrow-left"></i> Back
            </div>
            <h2>Login with Key</h2>
            <div class="form-group">
                <label for="login-key">Enter Your Key</label>
                <input type="text" id="login-key" placeholder="STR-XXXX-XXXX-XXXX">
                <div class="error" id="login-key-error">Key is required</div>
            </div>
            <div class="form-group pin-group">
                <label for="login-pin">Enter Your PIN</label>
                <input type="password" id="login-pin" placeholder="Enter your PIN" maxlength="6">
                <button class="pin-toggle" type="button" id="toggle-login-pin">
                    <i class="fas fa-eye"></i>
                </button>
                <div class="error" id="login-pin-error">PIN is required</div>
            </div>
            <button id="perform-login">Login</button>
        </div>

        <!-- Home Page -->
        <div class="page" id="home-page">
            <div class="home-header">
                <h1>Stroven Sit Locker</h1>
                <p>Manage Your Secure Keys</p>
            </div>
            
            <div class="keys-section">
                <h2 style="color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e8eaed;">Your Keys</h2>
                <div id="keys-list">
                    <!-- Keys will be dynamically added here -->
                    <div class="no-keys" id="no-keys-message">
                        <p>No keys found. Create your first key to get started.</p>
                    </div>
                </div>
            </div>
            
            <div class="options">
                <button id="create-new-key">Create New Key</button>
                <button class="secondary-btn" id="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <!-- Font Awesome for Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCnS5bEqwCJHSwUkDbA3gWBRvL3o5OIrrw",
            authDomain: "chat-app-b07dc.firebaseapp.com",
            databaseURL: "https://chat-app-b07dc-default-rtdb.firebaseio.com",
            projectId: "chat-app-b07dc",
            storageBucket: "chat-app-b07dc.firebasestorage.app",
            messagingSenderId: "366248300706",
            appId: "1:366248300706:web:70015a1c5c6e4a67e747fb",
            measurementId: "G-SJBYJ1788H"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const pages = document.querySelectorAll('.page');
        const welcomePage = document.getElementById('welcome-page');
        const createKeyPage = document.getElementById('create-key-page');
        const keyDisplayPage = document.getElementById('key-display-page');
        const loginPage = document.getElementById('login-page');
        const homePage = document.getElementById('home-page');
        
        // Buttons
        const createKeyBtn = document.getElementById('create-key-btn');
        const loginKeyBtn = document.getElementById('login-key-btn');
        const generateKeyBtn = document.getElementById('generate-key-btn');
        const backToWelcomeBtn = document.getElementById('back-to-welcome');
        const backToWelcome2Btn = document.getElementById('back-to-welcome2');
        const backToCreateBtn = document.getElementById('back-to-create');
        const copyKeyBtn = document.getElementById('copy-key-btn');
        const goToHomeBtn = document.getElementById('go-to-home');
        const performLoginBtn = document.getElementById('perform-login');
        const createNewKeyBtn = document.getElementById('create-new-key');
        const logoutBtn = document.getElementById('logout-btn');
        const togglePinBtn = document.getElementById('toggle-pin');
        const toggleLoginPinBtn = document.getElementById('toggle-login-pin');
        
        // Form inputs
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const userPin = document.getElementById('user-pin');
        const loginKey = document.getElementById('login-key');
        const loginPin = document.getElementById('login-pin');
        
        // Error messages
        const nameError = document.getElementById('name-error');
        const emailError = document.getElementById('email-error');
        const pinError = document.getElementById('pin-error');
        const loginKeyError = document.getElementById('login-key-error');
        const loginPinError = document.getElementById('login-pin-error');
        
        // Other elements
        const generatedKey = document.getElementById('generated-key');
        const keyUserName = document.getElementById('key-user-name');
        const keyUserEmail = document.getElementById('key-user-email');
        const keyCreatedAt = document.getElementById('key-created-at');
        const keysList = document.getElementById('keys-list');
        const noKeysMessage = document.getElementById('no-keys-message');
        const notification = document.getElementById('notification');
        const offlineIndicator = document.getElementById('offline-indicator');

        // Global variables
        let currentUser = null;
        let userKeys = [];

        // Show a specific page
        function showPage(page) {
            pages.forEach(p => p.classList.remove('active'));
            page.classList.add('active');
        }

        // Check online status
        function checkOnlineStatus() {
            if (!navigator.onLine) {
                offlineIndicator.style.display = 'block';
                return false;
            } else {
                offlineIndicator.style.display = 'none';
                return true;
            }
        }

        // Generate a unique key with duplicate checking
        async function generateUniqueKey() {
            let key;
            let isUnique = false;
            let attempts = 0;
            const maxAttempts = 10;
            
            while (!isUnique && attempts < maxAttempts) {
                const pattern = "STR-" + Math.random().toString(36).substring(2,6).toUpperCase() +
                                "-" + Math.random().toString(36).substring(2,6).toUpperCase() +
                                "-" + Math.random().toString(36).substring(2,6).toUpperCase();
                key = pattern;
                
                // Check if key already exists in Firebase
                try {
                    const existing = await database.ref('keys/' + key).once('value');
                    if (!existing.exists()) {
                        isUnique = true;
                    }
                } catch (error) {
                    console.error('Error checking key uniqueness:', error);
                    // If we can't check, assume it's unique to avoid infinite loop
                    isUnique = true;
                }
                
                attempts++;
            }
            
            if (!isUnique) {
                throw new Error('Could not generate unique key after ' + maxAttempts + ' attempts');
            }
            
            return key;
        }

        // Validate user details
        function validateUserDetails() {
            let isValid = true;
            
            // Validate name
            if (!userName.value.trim()) {
                nameError.style.display = 'block';
                isValid = false;
            } else {
                nameError.style.display = 'none';
            }
            
            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!userEmail.value || !emailRegex.test(userEmail.value)) {
                emailError.style.display = 'block';
                isValid = false;
            } else {
                emailError.style.display = 'none';
            }
            
            // Validate PIN
            const pinRegex = /^\d{4,6}$/;
            if (!userPin.value || !pinRegex.test(userPin.value)) {
                pinError.style.display = 'block';
                isValid = false;
            } else {
                pinError.style.display = 'none';
            }
            
            return isValid;
        }

        // Save key to Firebase with verification
        async function saveKeyToFirebase(key, userData) {
            // Sanitize email
            const sanitizedEmail = userData.email.trim().toLowerCase();
            const sanitizedName = userData.name.trim();
            
            const keyData = {
                name: sanitizedName,
                email: sanitizedEmail,
                password: userData.pin,
                createdAt: Date.now(),
                isActive: true,
                lastAccessed: Date.now()
            };
            
            // Save to Firebase
            await database.ref('keys/' + key).set(keyData);
            
            // Verify the write by reading back
            const confirm = await database.ref('keys/' + key).once('value');
            
            if (confirm.exists()) {
                console.log('Key saved to Firebase and verified');
                // Save minimal data to local storage
                saveKeyToLocalStorage({...keyData, key});
                return keyData;
            } else {
                throw new Error('Firebase write verification failed');
            }
        }

        // Save key to local storage (cache only)
        function saveKeyToLocalStorage(keyData) {
            let keys = JSON.parse(localStorage.getItem('strovenKeys')) || [];
            
            // Check if key already exists
            const existingKeyIndex = keys.findIndex(k => k.key === keyData.key);
            if (existingKeyIndex !== -1) {
                // Update existing key
                keys[existingKeyIndex] = keyData;
            } else {
                // Add new key
                keys.push(keyData);
            }
            
            localStorage.setItem('strovenKeys', JSON.stringify(keys));
            localStorage.setItem('strovenCurrentKey', keyData.key);
            userKeys = keys.filter(key => key.isActive !== false);
        }

        // Load keys from local storage
        function loadKeysFromLocalStorage() {
            const keys = JSON.parse(localStorage.getItem('strovenKeys')) || [];
            // Only show active keys
            userKeys = keys.filter(key => key.isActive !== false);
            displayKeys();
        }

        // Remove key (mark as inactive)
        async function removeKey(keyToRemove) {
            if (!checkOnlineStatus()) {
                showNotification('You are offline. Cannot remove key.', true);
                return;
            }
            
            // Mark key as inactive in Firebase
            await database.ref('keys/' + keyToRemove).update({ 
                isActive: false,
                deactivatedAt: Date.now()
            });
            
            // Verify the update
            const confirm = await database.ref('keys/' + keyToRemove).once('value');
            if (confirm.exists() && confirm.val().isActive === false) {
                // Remove from local storage
                let keys = JSON.parse(localStorage.getItem('strovenKeys')) || [];
                keys = keys.filter(key => key.key !== keyToRemove);
                localStorage.setItem('strovenKeys', JSON.stringify(keys));
                
                // If current key is being removed, clear current session
                if (localStorage.getItem('strovenCurrentKey') === keyToRemove) {
                    localStorage.removeItem('strovenCurrentKey');
                }
                
                // Reload keys
                loadKeysFromLocalStorage();
                showNotification('Key removed successfully');
            } else {
                showNotification('Error removing key', true);
            }
        }

        // Display keys on home page
        function displayKeys() {
            keysList.innerHTML = '';
            
            if (userKeys.length === 0) {
                noKeysMessage.style.display = 'block';
                return;
            }
            
            noKeysMessage.style.display = 'none';
            
            userKeys.forEach((keyData) => {
                const keyItem = document.createElement('div');
                keyItem.className = 'key-item';
                keyItem.innerHTML = `
                    <div class="key-header">
                        <div class="key-name">${keyData.name}</div>
                    </div>
                    <div class="key-email">${keyData.email}</div>
                    <div class="key-value">${keyData.key}</div>
                    <div class="key-actions">
                        <button class="action-btn copy-action" data-key="${keyData.key}">
                            <i class="far fa-copy"></i> Copy Key
                        </button>
                        <button class="action-btn remove-action" data-key="${keyData.key}">
                            <i class="fas fa-trash"></i> Remove Key
                        </button>
                    </div>
                `;
                
                keysList.appendChild(keyItem);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.copy-action').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const key = e.target.closest('button').dataset.key;
                    copyToClipboard(key);
                });
            });
            
            document.querySelectorAll('.remove-action').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const key = e.target.closest('button').dataset.key;
                    if (confirm('Are you sure you want to remove this key? It will become unusable.')) {
                        removeKey(key);
                    }
                });
            });
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    showNotification('Key copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    // Fallback method
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('Key copied to clipboard!');
                });
        }

        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Check key in Firebase
        async function checkKeyInFirebase(key) {
            try {
                const snapshot = await database.ref('keys/' + key).once('value');
                const keyData = snapshot.val();
                
                if (keyData && keyData.isActive !== false) {
                    // Update last accessed time
                    await database.ref('keys/' + key).update({
                        lastAccessed: Date.now()
                    });
                    return keyData;
                }
                return null;
            } catch (error) {
                console.error('Error checking key in Firebase:', error);
                throw error;
            }
        }

        // Login verification from Firebase
        async function verifyLogin(key, pin) {
            try {
                const keyData = await checkKeyInFirebase(key);
                
                if (!keyData) {
                    return { success: false, message: 'Invalid key or key has been deactivated' };
                }
                
                if (keyData.password !== pin) {
                    return { success: false, message: 'Incorrect PIN' };
                }
                
                return { success: true, data: keyData };
            } catch (error) {
                console.error('Login verification error:', error);
                return { success: false, message: 'Network error. Please try again.' };
            }
        }

        // Auto login on page load
        async function autoLogin() {
            const cachedKey = localStorage.getItem('strovenCurrentKey');
            if (cachedKey) {
                try {
                    if (!checkOnlineStatus()) {
                        // If offline, use cached data
                        const keys = JSON.parse(localStorage.getItem('strovenKeys')) || [];
                        const cachedData = keys.find(k => k.key === cachedKey);
                        if (cachedData) {
                            loadKeysFromLocalStorage();
                            showPage(homePage);
                            showNotification(`Welcome back, ${cachedData.name}! (Offline Mode)`);
                        }
                        return;
                    }
                    
                    const keyData = await checkKeyInFirebase(cachedKey);
                    if (keyData && keyData.isActive !== false) {
                        // Update local storage with fresh data
                        saveKeyToLocalStorage({...keyData, key: cachedKey});
                        loadKeysFromLocalStorage();
                        showPage(homePage);
                        showNotification(`Welcome back, ${keyData.name}!`);
                    } else {
                        // Key is invalid, clear local storage
                        localStorage.removeItem('strovenCurrentKey');
                    }
                } catch (error) {
                    console.error('Auto login error:', error);
                    // If online check fails, try cached data
                    const keys = JSON.parse(localStorage.getItem('strovenKeys')) || [];
                    const cachedData = keys.find(k => k.key === cachedKey);
                    if (cachedData) {
                        loadKeysFromLocalStorage();
                        showPage(homePage);
                        showNotification(`Welcome back, ${cachedData.name}! (Using cached data)`);
                    }
                }
            }
        }

        // Event Listeners
        createKeyBtn.addEventListener('click', () => {
            // Reset form
            userName.value = '';
            userEmail.value = '';
            userPin.value = '';
            nameError.style.display = 'none';
            emailError.style.display = 'none';
            pinError.style.display = 'none';
            
            showPage(createKeyPage);
        });

        loginKeyBtn.addEventListener('click', () => {
            loginKey.value = '';
            loginPin.value = '';
            loginKeyError.style.display = 'none';
            loginPinError.style.display = 'none';
            showPage(loginPage);
        });

        generateKeyBtn.addEventListener('click', async () => {
            if (!checkOnlineStatus()) {
                showNotification('You are offline. Cannot create key.', true);
                return;
            }
            
            if (validateUserDetails()) {
                // Show loading state
                generateKeyBtn.disabled = true;
                generateKeyBtn.textContent = 'Generating Key...';
                
                try {
                    // Generate unique key
                    const key = await generateUniqueKey();
                    generatedKey.textContent = key;
                    
                    // Save user data
                    const userData = {
                        name: userName.value,
                        email: userEmail.value,
                        pin: userPin.value
                    };
                    
                    // Display key info
                    keyUserName.textContent = userData.name;
                    keyUserEmail.textContent = userData.email;
                    keyCreatedAt.textContent = new Date().toLocaleString();
                    
                    // Save to Firebase with verification
                    await saveKeyToFirebase(key, userData);
                    
                    showPage(keyDisplayPage);
                    showNotification('Key created successfully!');
                } catch (error) {
                    console.error('Error generating key:', error);
                    showNotification('Error generating key. Please try again.', true);
                } finally {
                    // Reset button state
                    generateKeyBtn.disabled = false;
                    generateKeyBtn.textContent = 'Generate Key';
                }
            }
        });

        backToWelcomeBtn.addEventListener('click', () => {
            showPage(welcomePage);
        });

        backToWelcome2Btn.addEventListener('click', () => {
            showPage(welcomePage);
        });

        backToCreateBtn.addEventListener('click', () => {
            showPage(createKeyPage);
        });

        copyKeyBtn.addEventListener('click', () => {
            copyToClipboard(generatedKey.textContent);
        });

        goToHomeBtn.addEventListener('click', () => {
            loadKeysFromLocalStorage();
            showPage(homePage);
        });

        performLoginBtn.addEventListener('click', async () => {
            const key = loginKey.value.trim();
            const pin = loginPin.value.trim();
            
            if (!checkOnlineStatus()) {
                showNotification('You are offline. Cannot login.', true);
                return;
            }
            
            // Basic validation
            if (!key) {
                loginKeyError.textContent = 'Please enter your key';
                loginKeyError.style.display = 'block';
                return;
            } else {
                loginKeyError.style.display = 'none';
            }
            
            if (!pin) {
                loginPinError.textContent = 'Please enter your PIN';
                loginPinError.style.display = 'block';
                return;
            } else {
                loginPinError.style.display = 'none';
            }
            
            // Show loading state
            performLoginBtn.disabled = true;
            performLoginBtn.textContent = 'Verifying...';
            
            try {
                const result = await verifyLogin(key, pin);
                
                if (result.success) {
                    // Save to local storage
                    saveKeyToLocalStorage({...result.data, key});
                    loadKeysFromLocalStorage();
                    showPage(homePage);
                    showNotification(`Login successful! Welcome ${result.data.name}`);
                } else {
                    loginKeyError.textContent = result.message;
                    loginKeyError.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginKeyError.textContent = 'Network error. Please try again.';
                loginKeyError.style.display = 'block';
            } finally {
                // Reset button state
                performLoginBtn.disabled = false;
                performLoginBtn.textContent = 'Login';
            }
        });

        createNewKeyBtn.addEventListener('click', () => {
            showPage(createKeyPage);
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('strovenCurrentKey');
            showPage(welcomePage);
            showNotification('Logged out successfully');
        });

        // Toggle PIN visibility
        togglePinBtn.addEventListener('click', () => {
            const type = userPin.getAttribute('type') === 'password' ? 'text' : 'password';
            userPin.setAttribute('type', type);
            togglePinBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        toggleLoginPinBtn.addEventListener('click', () => {
            const type = loginPin.getAttribute('type') === 'password' ? 'text' : 'password';
            loginPin.setAttribute('type', type);
            toggleLoginPinBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });

        // Online/offline event listeners
        window.addEventListener('online', () => {
            checkOnlineStatus();
            showNotification('Connection restored');
        });

        window.addEventListener('offline', () => {
            checkOnlineStatus();
            showNotification('You are now offline', true);
        });

        // Global error handler
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.message);
            showNotification('Unexpected error occurred. Please check your connection.', true);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkOnlineStatus();
            // Auto login if valid key exists
            autoLogin();
        });
    </script>
</body>
</html>